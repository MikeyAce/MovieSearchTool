{% extends "index.html" %}
{% block head %}
{{ super() }}
{% endblock %}
{% block content %}
{{ super() }}

<script>
// Receive data and construct HTML page
var movieData = JSON.parse('{{ setti | tojson | safe}}');
var date_str = "";
var html_str = "";
var imdb_str = "https://www.imdb.com/title/"

// Sort data by date and time.
movieData.sort((a, b) => {
	if (a.showdate+a.showtime < b.showdate+b.showtime) return -1
	return a.showdate > b.showdate ? 1 : 0
})

// Loop through received data
for (i = 0; i < movieData.length; i++) 
{		
	// NYT TARKISTUS, ONKO LAJITYYPPI / OHJAAJA / MUU MITÄ HAETTIIN...
	if (movieData[i].showdate != date_str)
	{
		// SULJETAAN RIVI...
		if (i > 0) { html_str += "</div>" };
		// SEURAAVAN PÄIVÄN DATAT...
		html_str += '<h2 style="text-align: center;">' + movieData[i].showdate + "</h2>";
		date_str = movieData[i].showdate;
				
		// Luo container class diveille
		// OLIKO TÄMÄ NYT KOKO PASKAN SISÄLTÄVÄ DIV, VAI MIKÄ...
		html_str += '<div class="row">';
	}

	// NYT SITTEN TEE DIV JOKAISELLE TÄMÄN PÄIVÄN FILMILLE!

	html_str += '<div class="column" style="background-color:#898bed;">';
	html_str += '<div class="toprow">';
		
	// ALOITA TOP_LEFT
    // TEE KUVASTA LINKKI IMDb:hen!!!
	html_str += '<div class="topleft">';
    html_str += '<a href=' + imdb_str + movieData[i].imdb_id + ' target="_blank">';
    html_str += '<img src="' + movieData[i].img + ' alt=""></a>';

	html_str += "</div>" /* Suljetaan topleft */

	// ALOITA TOP_RIGHT	--->
	html_str += '<div class="topright">';

	html_str += "<b>" + movieData[i].name + " (" + movieData[i].year + ")</b><br>";
	html_str += 'Directed by: ' + movieData[i].director + "<br>";
	html_str += "Starring: " + movieData[i].actors;

	// KOKEILLAAN ARVION LISÄÄMISTÄ SIVULLE ERILLISELLÄ NAPILLA...

	html_str += "</div>"; // SULJE TOP_RIGHT
		
	// SULJE TOPROW!
	html_str += "</div>";
	
	// ALOITA MIDDLEROW, JONKA SISÄÄN KAKSI DIVIÄ:
	// NYT ALOITETAANKIN TAB!!
	// LAITETAAN ID PÄÄDIVILLE, KOSKA NÄITÄ TULEE USEAMPI
	html_str += '<div id=' + movieData[i].imdb_id + ' class="tab">';

	/* Create buttons for tab selection. Include imbd id for identification. 
	There are three tabs: 1) Info 2) Comment (write review) 3) Reviews */	

	html_str += '<button style="display:block" className = "active" class="tablinks" onclick="openPage(event,'; 
	html_str += "'Info'" + ",'";
	html_str += movieData[i].imdb_id + "'" + ')">Info</button>';
		
	html_str += '<button class="tablinks" onclick="openPage(event,'; 
	html_str += "'Comment'" + ",'";
	html_str += movieData[i].imdb_id + "'" + ')"> Comment</button > ';
	 
    html_str += '<button class="tablinks" onclick="openPage(event,';
	html_str += "'Reviews'" + ",'";
	html_str += movieData[i].imdb_id + "'" + ')">Reviews</button>';

	// <<=============== ENSIMMÄINEN TAB ========================>>
	// Laitetaan alidiveille id, että saadaan en yksilöityä...

	// Create tab contents accordingly

	html_str += "<div id=";

	// LISÄTÄÄN VIELÄ VALINTA TÄLLE TABILLE
	html_str += movieData[i].imdb_id + "Info" + ' class="tabcontent" style="display:block">';	

	html_str += "<br>";
	html_str += "<b>" + movieData[i].channel + " " + movieData[i].showtime + "</b>";
	html_str += " (" + movieData[i].runtime + ")";
	html_str += "<hr>";

    html_str += "<p><b>" + "Country: </b>" + movieData[i].country + "<br>";
	html_str += "<b>Genre: </b>" + movieData[i].genre + "<br>";
    html_str += "<b>Rated: </b>" + movieData[i].rated + "</p>"; 

    html_str += "</div>"; // SULJETAAN SISÄLTÖTAB

	// <<=============== TOINEN TAB ========================>>

	// Create second tab for movie. Includes a review form with submit button.
	// Use imdb id for identification

	html_str += "<div id=";
	html_str += movieData[i].imdb_id + "Comment" + ' class="tabcontent">';
		
	// Hidden fields used to store information for saving the review

	html_str += '<input type="hidden" id="imdb_id" name="imdb_id"'; 
    html_str += 'value = "' + movieData[i].imdb_id + '"></input>';
    html_str += '<input type="hidden" id="name" name="name"';
	html_str += 'value = "' + movieData[i].name + '"></input>';
	html_str += '<input type="hidden" id="fi_name" name="fi_name"';
	html_str += 'value = "' + movieData[i].fi_name + '"></input>';
	html_str += '<input type="hidden" id="year" name="year"';
	html_str += 'value = "' + movieData[i].year + '"></input>'; 

	// Create input field for name, text area for review, and a submit button  
    
    html_str+="<br>"
    html_str += 'Name: <input style="background-color: #c2c8fc;" type="text" id="reviewer" maxlength="20" size="20" name="reviewer" placeholder = "Your name..." required>';
	html_str += '<textarea class="reviews" id="review_txt" name="review_txt" rows="3"';
	html_str += 'cols = "35" placeholder = "Your review..." required></textarea><br>';
    html_str += '<button style="border: 1px solid grey;background-color: #c2c8fc;" class="review_button" id="but" value="but" name="but">Submit</button>';
    
	html_str += "</div>"; // SULJETAAN SISÄLTÖTAB	

	// <<=============== KOLMAS TAB ========================>>

    html_str += "<div " + 'style="font-size:0.8vw;overflow:scroll;"' + " id=";

	html_str += movieData[i].imdb_id + "Reviews" + ' class="tabcontent">';

    // NYT PITÄS LAJITELLA ARVIOT!! VIIMEISIN EKANA!!!    

    var reviews_tmp = movieData[i].reviews;
    var reviews = reviews_tmp.sort(SortByDate)    

    // LAJITTELU TEHTY

    for (r = 0; r < reviews.length; r++){
		html_str += "<br>";	
		html_str += '<div style="background-color:#c2c8fc;">';
        html_str += "<p><b>" + reviews[r].reviewer + "</b>";
        html_str += " wrote on " + reviews[r].timestamp.toString().split("GMT")[0] + ":</p>";
        html_str += "<p>" + reviews[r].review_txt + "</p>";        
		html_str += "</div>"; 
	}

	html_str += "</div>"; // SULJETAAN SISÄLTÖTAB
	html_str += "</div>" // Suljetaan tab class!

	// SITTEN MÄÄRITELLÄÄN SISÄLLÖT ----------->
	// NÄMÄ NYT PITÄS SAADA SINNE SISÄÄN...

	html_str += '</div>'; // COLUMN KIINNI KOKEEKSI TÄSSÄ, TÄMÄ OLI ALEMPANA KYL...
		
}
// Set constructed HTML string as page content	
var el = document.querySelector("#app");
el.innerHTML = html_str;

// Nyt vielä aseta kaikille Ensimmäinen tablin valituksi?!
tl = document.getElementsByClassName("tablinks");
for (i = 0; i < tl.length; i++) {
    if (tl[i].innerText == "Info") {
		console.log("NYT MÄTSÄÄ LINKS LOPUSSA!");
        tl[i].className += " active";
	}
}
function SortByDate(a, b){
    var aD = new Date(a.timestamp).getTime(), bD = new Date(b.timestamp).getTime(); 
    return ((aD > bD) ? -1 : ((aD < bD) ? 1 : 0));
}

function openPage(evt, pageName, imdbId) {
	var i, tabcontent, tablinks;
	var imdbIdPageName = imdbId + pageName;
	console.log("TULTIIN OPENPAGEEN " + pageName + " " + imdbId);
	tabcontent = document.getElementsByClassName("tabcontent");
	// NYT LUUPATAAN NE CONTENTIT, JOIDEN PARENTIN ID OIKEA...
	for (i = 0; i < tabcontent.length; i++) {
		if (tabcontent[i].parentNode.id == imdbId) {
			console.log("NYT MÄTSÄÄ CONTENT!");
			tabcontent[i].style.display = "none";
		}  	  
	}
	// JA NYT TABLINKSIT SAMALLA PERIAATTEELLA...
	tablinks = document.getElementsByClassName("tablinks");
	for (i = 0; i < tablinks.length; i++) {
		//if (tabcontent[i].parentNode.id == imdbId) {
            if (tablinks[i].parentNode.id == imdbId) {
			console.log("NYT MÄTSÄÄ LINKS!");
			tablinks[i].className = tablinks[i].className.replace(" active", "");
		}
	}
	document.getElementById(imdbIdPageName).style.display = "block";
	evt.currentTarget.className += " active";
}
</script>
{% endblock %}